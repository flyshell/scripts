<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HAProxy åŸŸåç®¡ç†</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .form-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fafafa;
        }
        .form-section h2 {
            color: #34495e;
            margin-top: 0;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input[type="text"], textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        textarea {
            height: 100px;
            resize: vertical;
        }
        button {
            background-color: #3498db;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        button:hover {
            background-color: #2980b9;
        }
        button.danger {
            background-color: #e74c3c;
        }
        button.danger:hover {
            background-color: #c0392b;
        }
        button.success {
            background-color: #27ae60;
        }
        button.success:hover {
            background-color: #229954;
        }
        .domain-list {
            margin-top: 30px;
        }
        .domain-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
            background-color: white;
        }
        .domain-info {
            flex-grow: 1;
        }
        .domain-name {
            font-weight: bold;
            color: #2c3e50;
            font-size: 18px;
        }
        .domain-status {
            color: #7f8c8d;
            font-size: 14px;
            margin-top: 5px;
        }
        .domain-actions {
            display: flex;
            gap: 10px;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status-active {
            background-color: #27ae60;
        }
        .status-inactive {
            background-color: #e74c3c;
        }
        .log-output {
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 20px;
        }
        .alert {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .alert-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .tabs {
            display: flex;
            border-bottom: 2px solid #ddd;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            color: #7f8c8d;
        }
        .tab.active {
            color: #3498db;
            border-bottom: 2px solid #3498db;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸŒ HAProxy åŸŸåç®¡ç†ç³»çµ±</h1>
        
        <!-- ç‹€æ…‹é¡¯ç¤ºå€ -->
        <div id="status-area"></div>
        
        <!-- æ¨™ç±¤é  -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('add-domain')">æ·»åŠ åŸŸå</button>
            <button class="tab" onclick="showTab('manage-domains')">ç®¡ç†åŸŸå</button>
            <button class="tab" onclick="showTab('ssl-certs')">SSL æ†‘è­‰</button>
            <button class="tab" onclick="showTab('logs')">ç³»çµ±æ—¥èªŒ</button>
        </div>
        
        <!-- æ·»åŠ åŸŸåæ¨™ç±¤é  -->
        <div id="add-domain" class="tab-content active">
            <div class="form-section">
                <h2>â• æ·»åŠ æ–°åŸŸå</h2>
                <form id="add-domain-form">
                    <div class="form-group">
                        <label for="domain-name">åŸŸå:</label>
                        <input type="text" id="domain-name" name="domain" placeholder="example.com" required>
                        <small style="color: #7f8c8d;">è«‹è¼¸å…¥ä¸å« www çš„åŸŸå</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="backend-servers">å¾Œç«¯æœå‹™å™¨:</label>
                        <textarea id="backend-servers" name="servers" 
                                placeholder="10.0.4.1:8002,10.0.4.2:8002" required></textarea>
                        <small style="color: #7f8c8d;">æ ¼å¼: IP:PORT,IP:PORT (ç”¨é€—è™Ÿåˆ†éš”å¤šå€‹æœå‹™å™¨)</small>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="auto-ssl" name="auto-ssl" checked>
                            è‡ªå‹•ç”¢ç”Ÿ SSL æ†‘è­‰
                        </label>
                    </div>
                    
                    <button type="submit">æ·»åŠ åŸŸå</button>
                </form>
            </div>
        </div>
        
        <!-- ç®¡ç†åŸŸåæ¨™ç±¤é  -->
        <div id="manage-domains" class="tab-content">
            <div class="form-section">
                <h2>ğŸ”§ åŸŸåç®¡ç†</h2>
                <button onclick="refreshDomainList()" class="success">åˆ·æ–°åˆ—è¡¨</button>
                <button onclick="testAllDomains()">æ¸¬è©¦æ‰€æœ‰åŸŸå</button>
                
                <div class="domain-list" id="domain-list">
                    <!-- åŸŸååˆ—è¡¨å°‡å‹•æ…‹è¼‰å…¥ -->
                </div>
            </div>
        </div>
        
        <!-- SSL æ†‘è­‰æ¨™ç±¤é  -->
        <div id="ssl-certs" class="tab-content">
            <div class="form-section">
                <h2>ğŸ”’ SSL æ†‘è­‰ç®¡ç†</h2>
                <button onclick="updateAllCerts()" class="success">æ›´æ–°æ‰€æœ‰æ†‘è­‰</button>
                <button onclick="checkCertExpiry()">æª¢æŸ¥æ†‘è­‰æœ‰æ•ˆæœŸ</button>
                
                <div id="cert-info">
                    <!-- æ†‘è­‰ä¿¡æ¯å°‡å‹•æ…‹è¼‰å…¥ -->
                </div>
            </div>
        </div>
        
        <!-- ç³»çµ±æ—¥èªŒæ¨™ç±¤é  -->
        <div id="logs" class="tab-content">
            <div class="form-section">
                <h2>ğŸ“‹ ç³»çµ±æ—¥èªŒ</h2>
                <button onclick="refreshLogs()">åˆ·æ–°æ—¥èªŒ</button>
                <button onclick="clearLogs()" class="danger">æ¸…ç©ºæ—¥èªŒ</button>
                
                <div class="log-output" id="log-output">
                    è¼‰å…¥ä¸­...
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let currentTab = 'add-domain';
        
        // æ¨™ç±¤é åˆ‡æ›
        function showTab(tabName) {
            // éš±è—æ‰€æœ‰æ¨™ç±¤é å…§å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰æ¨™ç±¤é çš„ active é¡åˆ¥
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // é¡¯ç¤ºé¸ä¸­çš„æ¨™ç±¤é å…§å®¹
            document.getElementById(tabName).classList.add('active');
            
            // æ·»åŠ é¸ä¸­æ¨™ç±¤é çš„ active é¡åˆ¥
            event.target.classList.add('active');
            
            currentTab = tabName;
            
            // æ ¹æ“šæ¨™ç±¤é è¼‰å…¥å°æ‡‰æ•¸æ“š
            switch(tabName) {
                case 'manage-domains':
                    refreshDomainList();
                    break;
                case 'ssl-certs':
                    checkCertExpiry();
                    break;
                case 'logs':
                    refreshLogs();
                    break;
            }
        }
        
        // é¡¯ç¤ºç‹€æ…‹æ¶ˆæ¯
        function showStatus(message, type = 'info') {
            const statusArea = document.getElementById('status-area');
            const alertClass = `alert-${type === 'error' ? 'error' : type === 'success' ? 'success' : 'warning'}`;
            
            statusArea.innerHTML = `
                <div class="alert ${alertClass}">
                    ${message}
                </div>
            `;
            
            // 5ç§’å¾Œè‡ªå‹•éš±è—
            setTimeout(() => {
                statusArea.innerHTML = '';
            }, 5000);
        }
        
        // åŸ·è¡Œ API èª¿ç”¨
        async function apiCall(action, data = {}) {
            try {
                const response = await fetch('/cgi-bin/haproxy-api.cgi', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: action,
                        ...data
                    })
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'è«‹æ±‚å¤±æ•—');
                }
                
                return result;
            } catch (error) {
                console.error('API èª¿ç”¨å¤±æ•—:', error);
                showStatus(`æ“ä½œå¤±æ•—: ${error.message}`, 'error');
                throw error;
            }
        }
        
        // æ·»åŠ åŸŸåè¡¨å–®æäº¤
        document.getElementById('add-domain-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const domain = formData.get('domain');
            const servers = formData.get('servers');
            const autoSsl = formData.get('auto-ssl') ? true : false;
            
            try {
                showStatus('æ­£åœ¨æ·»åŠ åŸŸåï¼Œè«‹ç¨å€™...', 'info');
                
                const result = await apiCall('add-domain', {
                    domain: domain,
                    servers: servers,
                    auto_ssl: autoSsl
                });
                
                showStatus(`åŸŸå ${domain} æ·»åŠ æˆåŠŸï¼`, 'success');
                
                // æ¸…ç©ºè¡¨å–®
                this.reset();
                
                // å¦‚æœåœ¨ç®¡ç†æ¨™ç±¤é ï¼Œåˆ·æ–°åˆ—è¡¨
                if (currentTab === 'manage-domains') {
                    refreshDomainList();
                }
                
            } catch (error) {
                // éŒ¯èª¤å·²åœ¨ apiCall ä¸­è™•ç†
            }
        });
        
        // åˆ·æ–°åŸŸååˆ—è¡¨
        async function refreshDomainList() {
            try {
                const result = await apiCall('list-domains');
                const domainList = document.getElementById('domain-list');
                
                if (result.domains && result.domains.length > 0) {
                    domainList.innerHTML = result.domains.map(domain => `
                        <div class="domain-item">
                            <div class="domain-info">
                                <div class="domain-name">
                                    <span class="status-indicator status-${domain.status}"></span>
                                    ${domain.name}
                                </div>
                                <div class="domain-status">
                                    æœå‹™å™¨: ${domain.servers} | SSL: ${domain.ssl_status} | æœ€å¾Œæª¢æŸ¥: ${domain.last_check}
                                </div>
                            </div>
                            <div class="domain-actions">
                                <button onclick="testDomain('${domain.name}')">æ¸¬è©¦</button>
                                <button onclick="editDomain('${domain.name}')">ç·¨è¼¯</button>
                                <button class="danger" onclick="removeDomain('${domain.name}')">åˆªé™¤</button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    domainList.innerHTML = '<p style="text-align: center; color: #7f8c8d;">æ²’æœ‰æ‰¾åˆ°ä»»ä½•åŸŸåé…ç½®</p>';
                }
                
            } catch (error) {
                document.getElementById('domain-list').innerHTML = '<p style="color: #e74c3c;">è¼‰å…¥åŸŸååˆ—è¡¨å¤±æ•—</p>';
            }
        }
        
        // æ¸¬è©¦åŸŸå
        async function testDomain(domain) {
            try {
                showStatus(`æ­£åœ¨æ¸¬è©¦åŸŸå ${domain}...`, 'info');
                
                const result = await apiCall('test-domain', { domain: domain });
                
                if (result.success) {
                    showStatus(`åŸŸå ${domain} æ¸¬è©¦é€šé`, 'success');
                } else {
                    showStatus(`åŸŸå ${domain} æ¸¬è©¦å¤±æ•—: ${result.error}`, 'error');
                }
                
            } catch (error) {
                // éŒ¯èª¤å·²åœ¨ apiCall ä¸­è™•ç†
            }
        }
        
        // æ¸¬è©¦æ‰€æœ‰åŸŸå
        async function testAllDomains() {
            try {
                showStatus('æ­£åœ¨æ¸¬è©¦æ‰€æœ‰åŸŸå...', 'info');
                
                const result = await apiCall('test-all-domains');
                
                showStatus(`æ¸¬è©¦å®Œæˆ: ${result.passed}/${result.total} å€‹åŸŸåé€šéæ¸¬è©¦`, 
                          result.passed === result.total ? 'success' : 'warning');
                
                // åˆ·æ–°åˆ—è¡¨ä»¥é¡¯ç¤ºæœ€æ–°ç‹€æ…‹
                refreshDomainList();
                
            } catch (error) {
                // éŒ¯èª¤å·²åœ¨ apiCall ä¸­è™•ç†
            }
        }
        
        // ç·¨è¼¯åŸŸå
        function editDomain(domain) {
            // é€™è£¡å¯ä»¥å¯¦ç¾ç·¨è¼¯åŠŸèƒ½
            showStatus(`ç·¨è¼¯åŠŸèƒ½é–‹ç™¼ä¸­: ${domain}`, 'warning');
        }
        
        // åˆªé™¤åŸŸå
        async function removeDomain(domain) {
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤åŸŸå ${domain} å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ã€‚`)) {
                return;
            }
            
            try {
                showStatus(`æ­£åœ¨åˆªé™¤åŸŸå ${domain}...`, 'info');
                
                const result = await apiCall('remove-domain', { domain: domain });
                
                showStatus(`åŸŸå ${domain} åˆªé™¤æˆåŠŸ`, 'success');
                
                // åˆ·æ–°åˆ—è¡¨
                refreshDomainList();
                
            } catch (error) {
                // éŒ¯èª¤å·²åœ¨ apiCall ä¸­è™•ç†
            }
        }
        
        // æ›´æ–°æ‰€æœ‰æ†‘è­‰
        async function updateAllCerts() {
            try {
                showStatus('æ­£åœ¨æ›´æ–°æ‰€æœ‰ SSL æ†‘è­‰ï¼Œè«‹ç¨å€™...', 'info');
                
                const result = await apiCall('update-ssl-certs');
                
                showStatus('SSL æ†‘è­‰æ›´æ–°å®Œæˆ', 'success');
                
                // åˆ·æ–°æ†‘è­‰ä¿¡æ¯
                checkCertExpiry();
                
            } catch (error) {
                // éŒ¯èª¤å·²åœ¨ apiCall ä¸­è™•ç†
            }
        }
        
        // æª¢æŸ¥æ†‘è­‰æœ‰æ•ˆæœŸ
        async function checkCertExpiry() {
            try {
                const result = await apiCall('check-cert-expiry');
                const certInfo = document.getElementById('cert-info');
                
                if (result.certificates && result.certificates.length > 0) {
                    certInfo.innerHTML = `
                        <h3>æ†‘è­‰ç‹€æ…‹</h3>
                        <div class="domain-list">
                            ${result.certificates.map(cert => `
                                <div class="domain-item">
                                    <div class="domain-info">
                                        <div class="domain-name">
                                            <span class="status-indicator status-${cert.status}"></span>
                                            ${cert.domain}
                                        </div>
                                        <div class="domain-status">
                                            æœ‰æ•ˆæœŸè‡³: ${cert.expiry} | å‰©é¤˜å¤©æ•¸: ${cert.days_left} | ç‹€æ…‹: ${cert.status_text}
                                        </div>
                                    </div>
                                    <div class="domain-actions">
                                        <button onclick="renewCert('${cert.domain}')">æ›´æ–°æ†‘è­‰</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    certInfo.innerHTML = '<p>æ²’æœ‰æ‰¾åˆ°ä»»ä½• SSL æ†‘è­‰</p>';
                }
                
            } catch (error) {
                document.getElementById('cert-info').innerHTML = '<p style="color: #e74c3c;">è¼‰å…¥æ†‘è­‰ä¿¡æ¯å¤±æ•—</p>';
            }
        }
        
        // æ›´æ–°å–®å€‹æ†‘è­‰
        async function renewCert(domain) {
            try {
                showStatus(`æ­£åœ¨æ›´æ–° ${domain} çš„ SSL æ†‘è­‰...`, 'info');
                
                const result = await apiCall('renew-cert', { domain: domain });
                
                showStatus(`${domain} çš„ SSL æ†‘è­‰æ›´æ–°æˆåŠŸ`, 'success');
                
                // åˆ·æ–°æ†‘è­‰ä¿¡æ¯
                checkCertExpiry();
                
            } catch (error) {
                // éŒ¯èª¤å·²åœ¨ apiCall ä¸­è™•ç†
            }
        }
        
        // åˆ·æ–°æ—¥èªŒ
        async function refreshLogs() {
            try {
                const result = await apiCall('get-logs');
                const logOutput = document.getElementById('log-output');
                
                logOutput.textContent = result.logs || 'æ²’æœ‰æ—¥èªŒå…§å®¹';
                
                // è‡ªå‹•æ»¾å‹•åˆ°åº•éƒ¨
                logOutput.scrollTop = logOutput.scrollHeight;
                
            } catch (error) {
                document.getElementById('log-output').textContent = 'è¼‰å…¥æ—¥èªŒå¤±æ•—';
            }
        }
        
        // æ¸…ç©ºæ—¥èªŒ
        async function clearLogs() {
            if (!confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰æ—¥èªŒå—ï¼Ÿ')) {
                return;
            }
            
            try {
                await apiCall('clear-logs');
                showStatus('æ—¥èªŒå·²æ¸…ç©º', 'success');
                refreshLogs();
                
            } catch (error) {
                // éŒ¯èª¤å·²åœ¨ apiCall ä¸­è™•ç†
            }
        }
        
        // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // è¼‰å…¥åˆå§‹æ•¸æ“š
            refreshLogs();
        });
        
        // å®šæœŸåˆ·æ–°ç‹€æ…‹ï¼ˆæ¯30ç§’ï¼‰
        setInterval(() => {
            if (currentTab === 'manage-domains') {
                refreshDomainList();
            } else if (currentTab === 'logs') {
                refreshLogs();
            }
        }, 30000);
    </script>
</body>
</html>
